From 0168c36f36598194deef65ef830d7f3053b5149a Mon Sep 17 00:00:00 2001
From: Lovely_xianxian <xyx_dada@outlook.com>
Date: Sat, 25 Apr 2020 20:05:29 +0800
Subject: [PATCH] Toggle Sending Chunks API

---
 .../java/net/minecraft/server/PlayerChunkMap.java   |  1 +
 .../org/bukkit/craftbukkit/entity/CraftPlayer.java  | 13 +++++++++++++
 2 files changed, 14 insertions(+)

diff --git a/src/main/java/net/minecraft/server/PlayerChunkMap.java b/src/main/java/net/minecraft/server/PlayerChunkMap.java
index 1c6b73d82..cd97800a2 100644
--- a/src/main/java/net/minecraft/server/PlayerChunkMap.java
+++ b/src/main/java/net/minecraft/server/PlayerChunkMap.java
@@ -204,6 +204,7 @@ public class PlayerChunkMap extends IChunkLoader implements PlayerChunk.d {
         }
 
         int trySendChunk(int chunkX, int chunkZ, EntityPlayer player) {
+            if (!player.getBukkitEntity().needSendChunks()) return QUEUED; // Nebula - Toggle sending chunks API
             long coordinate = net.minecraft.server.MCUtil.getCoordinateKey(chunkX, chunkZ);
             PlayerChunk playerChunk = PlayerChunkMap.this.getUpdatingChunk(coordinate);
 
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 6a25823bb..9c49e2033 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -2108,4 +2108,17 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         return spigot;
     }
     // Spigot end
+
+    // Nebula start - Toggle sending chunks API
+    private boolean needSendChunks = true;
+    @Override
+    public void setSendChunks(boolean sendChunks) {
+        this.needSendChunks = true;
+    }
+
+    @Override
+    public boolean needSendChunks() {
+        return needSendChunks;
+    }
+    // Nebula end
 }
-- 
2.25.0

