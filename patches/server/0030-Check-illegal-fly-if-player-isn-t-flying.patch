From d30991028f183c83eacbdb884942f094d195a881 Mon Sep 17 00:00:00 2001
From: Lovely_xianxian <xyx_dada@outlook.com>
Date: Sat, 9 May 2020 18:46:50 +0800
Subject: [PATCH] Check illegal fly if player isn't flying

---
 src/main/java/net/minecraft/server/PlayerConnection.java | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index ae8145488..7edc3c65d 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -1184,7 +1184,7 @@ public class PlayerConnection implements PacketListenerPlayIn {
                             this.player.setLocation(d4, d5, d6, f, f1); // Copied from above
 
                             // MC-135989, SPIGOT-5564: isRiptiding
-                            this.B = d12 >= -0.03125D && this.player.playerInteractManager.getGameMode() != EnumGamemode.SPECTATOR && !this.minecraftServer.getAllowFlight() && !this.player.abilities.canFly && !this.player.hasEffect(MobEffects.LEVITATION) && !this.player.isGliding() && !worldserver.b(this.player.getBoundingBox().g(0.0625D).b(0.0D, -0.55D, 0.0D)) && !this.player.isRiptiding();
+                            this.B = d12 >= -0.03125D && this.player.playerInteractManager.getGameMode() != EnumGamemode.SPECTATOR && !this.minecraftServer.getAllowFlight() && (!this.player.abilities.canFly || !this.player.abilities.isFlying) && !this.player.hasEffect(MobEffects.LEVITATION) && !this.player.isGliding() && !worldserver.b(this.player.getBoundingBox().g(0.0625D).b(0.0D, -0.55D, 0.0D)) && !this.player.isRiptiding(); // Nebula - Check if player is not flying
                             // CraftBukkit end
                             this.player.onGround = packetplayinflying.b();
                             this.player.getWorldServer().getChunkProvider().movePlayer(this.player);
-- 
2.26.2

