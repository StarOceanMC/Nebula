From 41498adeca922f2ec5485208cbf2aacecd83f15d Mon Sep 17 00:00:00 2001
From: Lovely_xianxian <xyx_dada@outlook.com>
Date: Sun, 10 May 2020 14:50:00 +0800
Subject: [PATCH] Only send entities when needSendChunks is false

---
 src/main/java/net/minecraft/server/Chunk.java          | 1 -
 src/main/java/net/minecraft/server/PlayerChunkMap.java | 6 +++++-
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/src/main/java/net/minecraft/server/Chunk.java b/src/main/java/net/minecraft/server/Chunk.java
index da73c560..09b8f9a3 100644
--- a/src/main/java/net/minecraft/server/Chunk.java
+++ b/src/main/java/net/minecraft/server/Chunk.java
@@ -285,7 +285,6 @@ public class Chunk implements IChunkAccess {
                             continue;
                         }
                         EntityPlayer player = (EntityPlayer)temp;
-                        if (player.getBukkitEntity().needSendChunks()) // Nebula - Toggle Chunk Sending API
                         chunkMap.sendChunk(player, chunkPackets, Chunk.this);
                     }
                 })));
diff --git a/src/main/java/net/minecraft/server/PlayerChunkMap.java b/src/main/java/net/minecraft/server/PlayerChunkMap.java
index ab751b48..0c949ed2 100644
--- a/src/main/java/net/minecraft/server/PlayerChunkMap.java
+++ b/src/main/java/net/minecraft/server/PlayerChunkMap.java
@@ -2155,6 +2155,8 @@ Sections go from 0..16. Now whenever a section is not empty, it can potentially
 
     final void sendChunk(EntityPlayer entityplayer, Packet<?>[] apacket, Chunk chunk) { this.a(entityplayer, apacket, chunk); } // Paper - OBFHELPER
     private void a(EntityPlayer entityplayer, Packet<?>[] apacket, Chunk chunk) {
+        // Nebula start - Only send entities when needSendChunks is false
+        if (entityplayer.getBukkitEntity().needSendChunks()) {
         if (apacket[0] == null) {
             // Paper start - add 8 for light fix workaround
             if (apacket.length != 10) { // in case Plugins call sendChunk, resize
@@ -2218,8 +2220,10 @@ Sections go from 0..16. Now whenever a section is not empty, it can potentially
             }
         }
         // Paper end - Fix MC-162253
-
+            
         entityplayer.a(chunk.getPos(), apacket[0], apacket[1]);
+        }
+        // Nebula end
         PacketDebug.a(this.world, chunk.getPos());
         List<Entity> list = Lists.newArrayList();
         List<Entity> list1 = Lists.newArrayList();
-- 
2.27.0

