From 8eab8e2d06eb127e4d5fbb554803365d4f432bd0 Mon Sep 17 00:00:00 2001
From: Lovely_xianxian <xyx_dada@outlook.com>
Date: Sat, 9 May 2020 18:46:50 +0800
Subject: [PATCH] Check illegal fly if player isn't flying

---
 src/main/java/net/minecraft/server/PlayerConnection.java | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index da1166d9..e8506bd1 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -1200,7 +1200,7 @@ public class PlayerConnection implements PacketListenerPlayIn {
                                 this.player.setLocation(d4, d5, d6, f, f1); // Copied from above
 
                                 // MC-135989, SPIGOT-5564: isRiptiding
-                                this.B = d12 >= -0.03125D && this.player.playerInteractManager.getGameMode() != EnumGamemode.SPECTATOR && !this.minecraftServer.getAllowFlight() && !this.player.abilities.canFly && !this.player.hasEffect(MobEffects.LEVITATION) && !this.player.isGliding() && this.a((Entity) this.player) && !this.player.isRiptiding();
+                                this.B = d12 >= -0.03125D && this.player.playerInteractManager.getGameMode() != EnumGamemode.SPECTATOR && !this.minecraftServer.getAllowFlight() && (!this.player.abilities.canFly || !this.player.abilities.isFlying) && !this.player.hasEffect(MobEffects.LEVITATION) && !this.player.isGliding() && this.a((Entity) this.player) && !this.player.isRiptiding();
                                 // CraftBukkit end
                                 this.player.getWorldServer().getChunkProvider().movePlayer(this.player);
                                 this.player.a(this.player.locY() - d3, packetplayinflying.b());
-- 
2.27.0

