From 2913f0ecea239690854924441674ee56c4906c64 Mon Sep 17 00:00:00 2001
From: Lovely_xianxian <xyx_dada@outlook.com>
Date: Wed, 1 Apr 2020 12:18:45 +0800
Subject: [PATCH] Fire PlayerPostTeleportEvent

---
 src/main/java/net/minecraft/server/EntityEnderPearl.java    | 2 ++
 src/main/java/net/minecraft/server/EntityPlayer.java        | 5 +++--
 src/main/java/net/minecraft/server/ItemChorusFruit.java     | 6 ++++--
 src/main/java/net/minecraft/server/PlayerConnection.java    | 5 +++--
 .../java/org/bukkit/craftbukkit/entity/CraftPlayer.java     | 2 ++
 5 files changed, 14 insertions(+), 6 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityEnderPearl.java b/src/main/java/net/minecraft/server/EntityEnderPearl.java
index 73069ba39..555e27751 100644
--- a/src/main/java/net/minecraft/server/EntityEnderPearl.java
+++ b/src/main/java/net/minecraft/server/EntityEnderPearl.java
@@ -6,6 +6,7 @@ import org.bukkit.Bukkit;
 import org.bukkit.craftbukkit.event.CraftEventFactory;
 import org.bukkit.event.entity.CreatureSpawnEvent;
 import org.bukkit.event.player.PlayerTeleportEvent;
+import xianxian.mc.nebula.event.player.PlayerPostTeleportEvent;
 // CraftBukkit end
 
 public class EntityEnderPearl extends EntityProjectileThrowable {
@@ -98,6 +99,7 @@ public class EntityEnderPearl extends EntityProjectileThrowable {
                         CraftEventFactory.entityDamage = this;
                         entityliving.damageEntity(DamageSource.FALL, 5.0F);
                         CraftEventFactory.entityDamage = null;
+                        PlayerPostTeleportEvent.callEvent(teleEvent); // Nebula - Fire PlayerPostTeleportEvent
                     }
                     // CraftBukkit end
                 }
diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index c88177b77..ba85ff672 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -5,7 +5,7 @@ import com.google.common.collect.Lists;
 import com.destroystokyo.paper.event.player.PlayerClientOptionsChangeEvent; // Paper
 import com.mojang.authlib.GameProfile;
 import com.mojang.datafixers.util.Either;
-import io.netty.util.concurrent.Future;
+
 import java.util.ArrayDeque; // Paper
 import java.util.Collection;
 import java.util.Deque; // Paper
@@ -18,7 +18,6 @@ import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
 
 // CraftBukkit start
-import com.google.common.base.Preconditions;
 import org.bukkit.Bukkit;
 import org.bukkit.GameMode;
 import org.bukkit.Location;
@@ -36,6 +35,7 @@ import org.bukkit.event.player.PlayerPortalEvent;
 import org.bukkit.event.player.PlayerTeleportEvent;
 import org.bukkit.event.player.PlayerTeleportEvent.TeleportCause;
 import org.bukkit.inventory.MainHand;
+import xianxian.mc.nebula.event.player.PlayerPostTeleportEvent;
 // CraftBukkit end
 
 public class EntityPlayer extends EntityHuman implements ICrafting {
@@ -1010,6 +1010,7 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
             PlayerChangedWorldEvent changeEvent = new PlayerChangedWorldEvent(this.getBukkitEntity(), worldserver.getWorld());
             this.world.getServer().getPluginManager().callEvent(changeEvent);
             // CraftBukkit end
+            PlayerPostTeleportEvent.callEvent(tpEvent); // Nebula - Fire PlayerPostTeleportEvent
             return this;
         }
     }
diff --git a/src/main/java/net/minecraft/server/ItemChorusFruit.java b/src/main/java/net/minecraft/server/ItemChorusFruit.java
index ce4d4ace8..c448ccaf4 100644
--- a/src/main/java/net/minecraft/server/ItemChorusFruit.java
+++ b/src/main/java/net/minecraft/server/ItemChorusFruit.java
@@ -4,6 +4,7 @@ package net.minecraft.server;
 import org.bukkit.Location;
 import org.bukkit.entity.Player;
 import org.bukkit.event.player.PlayerTeleportEvent;
+import xianxian.mc.nebula.event.player.PlayerPostTeleportEvent;
 // CraftBukkit end
 
 public class ItemChorusFruit extends Item {
@@ -25,11 +26,11 @@ public class ItemChorusFruit extends Item {
                 double d3 = entityliving.locX() + (entityliving.getRandom().nextDouble() - 0.5D) * 16.0D;
                 double d4 = MathHelper.a(entityliving.locY() + (double) (entityliving.getRandom().nextInt(16) - 8), 0.0D, (double) (world.getHeight() - 1));
                 double d5 = entityliving.locZ() + (entityliving.getRandom().nextDouble() - 0.5D) * 16.0D;
-
+                PlayerTeleportEvent teleEvent = null; // Nebula - Fire PlayerPostTeleportEvent
                 // CraftBukkit start
                 if (entityliving instanceof EntityPlayer) {
                     Player player = ((EntityPlayer) entityliving).getBukkitEntity();
-                    PlayerTeleportEvent teleEvent = new PlayerTeleportEvent(player, player.getLocation(), new Location(player.getWorld(), d3, d4, d5), PlayerTeleportEvent.TeleportCause.CHORUS_FRUIT);
+                    teleEvent = new PlayerTeleportEvent(player, player.getLocation(), new Location(player.getWorld(), d3, d4, d5), PlayerTeleportEvent.TeleportCause.CHORUS_FRUIT);
                     world.getServer().getPluginManager().callEvent(teleEvent);
                     if (teleEvent.isCancelled()) {
                         break;
@@ -47,6 +48,7 @@ public class ItemChorusFruit extends Item {
                 if (entityliving.a(d3, d4, d5, true)) {
                     world.playSound((EntityHuman) null, d0, d1, d2, SoundEffects.ITEM_CHORUS_FRUIT_TELEPORT, SoundCategory.PLAYERS, 1.0F, 1.0F);
                     entityliving.a(SoundEffects.ITEM_CHORUS_FRUIT_TELEPORT, 1.0F, 1.0F);
+                    if (teleEvent != null) PlayerPostTeleportEvent.callEvent(teleEvent); // Nebula - Fire PlayerPostTeleportEvent
                     break;
                 }
             }
diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 455dd1de0..ae8145488 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -14,7 +14,7 @@ import java.util.Iterator;
 import java.util.Optional;
 import java.util.Set;
 import javax.annotation.Nullable;
-import org.apache.commons.lang3.StringEscapeUtils;
+
 import org.apache.commons.lang3.StringUtils;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
@@ -59,9 +59,9 @@ import org.bukkit.inventory.CraftingInventory;
 import org.bukkit.inventory.EquipmentSlot;
 import org.bukkit.inventory.InventoryView;
 import org.bukkit.util.NumberConversions;
-import com.destroystokyo.paper.event.player.IllegalPacketEvent; // Paper
 import com.destroystokyo.paper.event.player.PlayerJumpEvent; // Paper
 import co.aikar.timings.MinecraftTimings; // Paper
+import xianxian.mc.nebula.event.player.PlayerPostTeleportEvent;
 // CraftBukkit end
 
 public class PlayerConnection implements PacketListenerPlayIn {
@@ -1248,6 +1248,7 @@ public class PlayerConnection implements PacketListenerPlayIn {
         }
 
         this.internalTeleport(d0, d1, d2, f, f1, set);
+        PlayerPostTeleportEvent.callEvent(event); // Nebula - Fire PlayerPostTeleportEvent
     }
 
     public void teleport(Location dest) {
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index bd4d5184b..017ddfb88 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -124,6 +124,7 @@ import org.bukkit.plugin.messaging.StandardMessenger;
 import org.bukkit.scoreboard.Scoreboard;
 
 import net.md_5.bungee.api.chat.BaseComponent; // Spigot
+import xianxian.mc.nebula.event.player.PlayerPostTeleportEvent;
 
 @DelegateDeserialization(CraftOfflinePlayer.class)
 public class CraftPlayer extends CraftHumanEntity implements Player {
@@ -798,6 +799,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         } else {
             server.getHandle().moveToWorld(entity, toWorld.getWorldProvider().getDimensionManager(), true, to, !toWorld.paperConfig.disableTeleportationSuffocationCheck);
         }
+        PlayerPostTeleportEvent.callEvent(event); // Nebula - Fire PlayerPostTeleportEvent
         return true;
     }
 
-- 
2.26.2

