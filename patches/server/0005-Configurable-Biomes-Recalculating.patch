From ccfb5963e52f23a829bd4966f22db0571e3ba5db Mon Sep 17 00:00:00 2001
From: Lovely_xianxian <xyx_dada@outlook.com>
Date: Fri, 27 Dec 2019 22:00:26 +0800
Subject: [PATCH] Configurable Biomes Recalculating

---
 .../java/net/minecraft/server/ChunkRegionLoader.java     | 7 ++++++-
 src/main/java/xianxian/mc/nebula/NebulaWorldConfig.java  | 9 +++++++++
 2 files changed, 15 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/ChunkRegionLoader.java b/src/main/java/net/minecraft/server/ChunkRegionLoader.java
index d529b795..de7b86e6 100644
--- a/src/main/java/net/minecraft/server/ChunkRegionLoader.java
+++ b/src/main/java/net/minecraft/server/ChunkRegionLoader.java
@@ -70,7 +70,12 @@ public class ChunkRegionLoader {
             ChunkRegionLoader.LOGGER.error("Chunk file at {} is in the wrong location; relocating. (Expected {}, got {})", chunkcoordintpair, chunkcoordintpair, chunkcoordintpair1);
         }
 
-        BiomeStorage biomestorage = new BiomeStorage(chunkcoordintpair, worldchunkmanager, nbttagcompound1.hasKeyOfType("Biomes", 11) ? nbttagcompound1.getIntArray("Biomes") : null);
+        // Nebula start - Configurable Biomes Recalculating 
+        String biomesVersion = worldserver.nebulaConfig.biomesRecalculatingTag;
+        boolean isNeedRegenerateBiome = worldserver.nebulaConfig.needRegenerateBiomes && !(nbttagcompound1.hasKey("BiomesVersion") && nbttagcompound1.getString("BiomesVersion").equals(biomesVersion));
+        BiomeStorage biomestorage = new BiomeStorage(chunkcoordintpair, worldchunkmanager, (nbttagcompound1.hasKeyOfType("Biomes", 11) && isNeedRegenerateBiome) ? nbttagcompound1.getIntArray("Biomes") : null);
+        nbttagcompound1.setString("BiomesVersion", biomesVersion);
+        // Nebula end
         ChunkConverter chunkconverter = nbttagcompound1.hasKeyOfType("UpgradeData", 10) ? new ChunkConverter(nbttagcompound1.getCompound("UpgradeData")) : ChunkConverter.a;
         ProtoChunkTickList<Block> protochunkticklist = new ProtoChunkTickList<>((block) -> {
             return block == null || block.getBlockData().isAir();
diff --git a/src/main/java/xianxian/mc/nebula/NebulaWorldConfig.java b/src/main/java/xianxian/mc/nebula/NebulaWorldConfig.java
index 84485572..916f64ea 100644
--- a/src/main/java/xianxian/mc/nebula/NebulaWorldConfig.java
+++ b/src/main/java/xianxian/mc/nebula/NebulaWorldConfig.java
@@ -79,5 +79,14 @@ public class NebulaWorldConfig {
 		itemFrameBreakInGlass = getBoolean("item-frame-break-in-glass", true);
 	}
 
+	public boolean needRegenerateBiomes = true;
+	private void needRegenerateBiomes() {
+		itemFrameBreakInGlass = getBoolean("need-regenerate-biomes", true);
+	}
 	
+	public String biomesRecalculatingTag = "Unknown";
+	private void biomesRecalculatingTag() {
+		biomesRecalculatingTag = getString("biomes-recalculating-tag", "1.15.1-1");
+	}
+
 }
-- 
2.25.0

