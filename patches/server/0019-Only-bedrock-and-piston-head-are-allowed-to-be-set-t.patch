From c3ef39f9f76e2ef9262e2fca09023797c6e09a6c Mon Sep 17 00:00:00 2001
From: Lovely_xianxian <xyx_dada@outlook.com>
Date: Tue, 7 Apr 2020 12:10:41 +0800
Subject: [PATCH] Only bedrock and piston head are allowed to be set to air

---
 .../java/net/minecraft/server/BlockPiston.java    | 15 +++++++--------
 1 file changed, 7 insertions(+), 8 deletions(-)

diff --git a/src/main/java/net/minecraft/server/BlockPiston.java b/src/main/java/net/minecraft/server/BlockPiston.java
index 4f10ca5a..84796dc9 100644
--- a/src/main/java/net/minecraft/server/BlockPiston.java
+++ b/src/main/java/net/minecraft/server/BlockPiston.java
@@ -231,14 +231,13 @@ public class BlockPiston extends BlockDirectional {
                     }
                 }
             } else {
-                // Paper start - fix headless pistons breaking blocks
-                BlockPosition headPos = blockposition.shift(enumdirection);
-                if (com.destroystokyo.paper.PaperConfig.allowBlockPermanentBreakingExploits || world.getType(headPos) == Blocks.PISTON_HEAD.getBlockData().set(FACING, enumdirection)) { // double check to make sure we're not a headless piston.
-                    world.setAir(headPos, false);
-                } else {
-                    ((WorldServer)world).getChunkProvider().flagDirty(headPos); // ... fix client desync
-                }
-                // Paper end - fix headless pistons breaking blocks
+                // Nebula start - Only bedrock and piston head are allowed to be set to air
+                BlockPosition headPosition = blockposition.shift(enumdirection);
+                IBlockData headData = world.getType(headPosition);
+                Block headBlock = headData.getBlock();
+                if (com.destroystokyo.paper.PaperConfig.allowBlockPermanentBreakingExploits || headBlock == Blocks.BEDROCK || headBlock == Blocks.PISTON_HEAD)
+                // Nebula end
+                world.a(headPosition, false);
             }
 
             world.playSound((EntityHuman) null, blockposition, SoundEffects.BLOCK_PISTON_CONTRACT, SoundCategory.BLOCKS, 0.5F, world.random.nextFloat() * 0.15F + 0.6F);
-- 
2.27.0

